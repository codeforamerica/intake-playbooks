---
- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - set_fact: time="{{lookup('pipe','date +%Y%m%d%H%M%S')}}"
    - set_fact: root_path="/project/intake-{{ time }}"
    - set_fact: venv_path="{{ root_path }}/venv"
    - set_fact: project_path="{{ root_path }}/intake"

    - rds:
        command: facts
        instance_name: "{{ project_slug }}-database"
        region: "{{ region }}"
      register: database

    - name: Create Root Directory
      file:
        path: "{{ root_path }}"
        state: directory

    - name: Create Project Directories
      file:
        path: "{{ project_path }}"
        state: directory

    - name: Download Project
      git:
        repo: 'https://github.com/codeforamerica/intake.git'
        dest: "{{ project_path }}"
        version: feature/zappa_changes

    - name: Create virtualenv
      shell: "export PYTHONPATH=python3.6 && virtualenv --no-site-packages -p/usr/bin/python3.6 {{ venv_path }}"
      args:
        executable: /bin/bash

    - name: Install Project requirements
      shell: "export PYTHONPATH=python3.6 &&  source {{ venv_path }}/bin/activate && {{ venv_path }}/bin/pip install -r {{ project_path }}/requirements/zappa.txt"
      args:
        executable: /bin/bash

    - name: Install NPM requirements
      shell: "npm install"
      args:
        chdir: "{{ project_path }}"

    - name: Create Zappa Settings File
      template:
        src: templates/zappa_settings.json.j2
        dest: "{{ project_path  }}/zappa_settings.json"

    - name: Create Local Environment File
      template:
        src: templates/project-envs.j2
        dest: "{{ project_path  }}/project-envs"

    - name: Running Collectstatic
      shell: "export PYTHONPATH=python3.6 &&  source project-envs && {{ venv_path }}/bin/python ./manage.py collectstatic --no-input --settings project.settings.development"
      args:
        chdir: "{{ project_path }}"
        executable: /bin/bash

    - name: Running Compressor
      shell: "export PYTHONPATH=python3.6 &&  source project-envs && {{ venv_path }}/bin/python ./manage.py compress --engine jinja2 --extension jinja --settings project.settings.development"
      args:
        chdir: "{{ project_path }}"
        executable: /bin/bash

    - name: Update Lambda function
      shell: "export PYTHONPATH=python3.6 &&  source project-envs && source {{ venv_path }}/bin/activate && {{ venv_path }}/bin/zappa update development"
      args:
        chdir: "{{ project_path }}"
        executable: /bin/bash

    - name: Run Migations
      shell: "export PYTHONPATH=python3.6 &&  source project-envs && source {{ venv_path }}/bin/activate && {{ venv_path }}/bin/zappa manage development migrate"
      args:
        chdir: "{{ project_path }}"
        executable: /bin/bash


